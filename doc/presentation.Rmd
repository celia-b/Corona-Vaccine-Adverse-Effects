---
title: 22100 - R for Bio Data Science
subtitle: Final Project
author: Alexandra Weronika Balicki, Celia Burgos Sequeros, Isabel Diaz-Pines Cort & Sofie Schovsbo

date: May 10, 2021
output: 
  ioslides_presentation:
    widescreen: true
    smaller: true
header-includes:
  - \usepackage{multicol}
  - \setlength{\columnsep}{18pt}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r include=FALSE}
library(tidyverse)
library(knitr)
```


## Project Outline
1. Introduction
2. Materials and methods
3. Results and discussion

  3.1 Exploratory data analysis
  3.2 Modeling
  
4. Conclusion


# Introduction

## Introduction: Dataset | COVID-19 World Vaccine Adverse Reactions

- Data from the Vaccine Adverse Event Reporting System (VAERS) created by the Food and Drug Administration (FDA) and Centers for Disease Control and Prevention (CDC) 
- Contains 3 datasets: 
    1. PATIENTS.CSV
    2. VACCINES.CSV
    3. SYMPTOMS.CSV
- Datasets connected by patient IDs (VAERS_ID)

```{r message=TRUE, warning=TRUE, include=FALSE}
patients <- read_csv(file = gzfile("../data/01_patients.csv.gz"), 
                     col_types = cols("BIRTH_DEFECT" = col_character(),
                                      "X_STAY" = col_character(),
                                      "RPT_DATE" = col_date(format="%Y-%m-%d"),
                                      "V_FUNDBY" = col_character(),
                                      "ER_VISIT" = col_character()))

symptoms <- read_csv(file = gzfile("../data/01_symptoms.csv.gz"))

vaccines <- read_csv(file = gzfile("../data/01_vaccines.csv.gz"),
                     col_types = cols("VAX_DOSE_SERIES" = col_character()))
```



## Introduction: Dataset | COVID-19 World Vaccine Adverse Reactions

**PATIENTS.CSV**: Contains information about the individuals that received the vaccines

```{r echo=FALSE}
patients %>%
  print(n=3)
```



## Introduction: Dataset | COVID-19 World Vaccine Adverse Reactions

**VACCINES.CSV**: Contains information about the received vaccine

```{r echo=FALSE}
vaccines %>% 
  print(head = 5) 
```



## Introduction: Dataset | COVID-19 World Vaccine Adverse Reactions
 
**SYMPTOMS.CSV**: Contains information about the symptoms experienced after vaccination

```{r echo=FALSE}
symptoms %>%
  print(n = 6)
```



## Introduction: Aim
The aim of this project is to gain insight on the adverse effects of different Covid-19 vaccines and answer questions such as:

- Do some vaccines cause more/different symptoms than others?

- Do patients with some profiles get more/different symptoms?

- Are certain symptoms correlated with death?

- Is patient profile correlated with death?

- Does taking anti-inflammatory drugs reduce the chance of having symptoms?


# Methods

## Methods: Project workflow

```{r workflow, echo = FALSE, out.width = "60%", out.extra = 'style = "float:right; padding:10px"'}
include_graphics("../doc/workflow.jpeg")
```

1. Load data sets (patients, vaccines, symptoms)
2. Clean each data set individually
3. Augment and merge the data sets
4. Exploratory data analysis

 - Visualizations
 - PCA
 
5. Modelling

  - Logistic regressions
  - Proportion testing


## Methods: Challenges and solutions 

### Cleaning

- **NAs** that should be interpreted as "no" &rightarrow; **replace_na**(ALLERGIES = "N") 
- **Duplicated IDs** &rightarrow; **add_count**(VAERS_ID) **%>% filter**(n == 1) **%>% select**(-n)

### Augment

- Columns containing **long string descriptions** &rightarrow; Make **tidy categorical (Y/N) variables** 

```{r, echo= FALSE, warning=FALSE, message=FALSE}
clean <- read_csv(gzfile("../data/02_patients_clean.csv.gz"))
aug <- read_csv(gzfile("../data/03_patients_clean_aug.csv.gz"))
clean %>%
  inner_join(aug, by = "VAERS_ID") %>%
  select(VAERS_ID, OTHER_MEDS, TAKES_ANTIINFLAMATORY) %>%
  filter(VAERS_ID == '0916988'|
           VAERS_ID == '0916983'|
           VAERS_ID == '0916996')
```

- **Too many symptoms** and untidy &rightarrow; extract **top 20 occurring symptoms** and turn them into **tidy categorical (TRUE/FALSE) columns**



# Exploratory Data Analysis | Visualization

## Visualization | Group representation: Age, sex and manufacturer

```{r age_dist, echo = FALSE, out.width = "60%", out.height = "350px", fig.show='hold', out.extra='style = "float:right;padding:10px"'}
include_graphics("../results/age_dist.png")

```

```{r message=FALSE, warning=FALSE, echo=FALSE}
merged_data_wide <- read_csv(gzfile("../data/03_merged_data_wide.csv.gz"))
merged_data_wide %>% 
  count (SEX) 

merged_data_wide %>% 
  count (VAX_MANU)
  
```


## Visualization | When do symptoms appear?

```{r symptoms_after_v_agegroup, echo = FALSE, out.width = "750px", out.height= "350px", fig.align = "center"}
include_graphics("../results/symptoms_after_dist_age.png")

```

Hypothesis: two peaks corresponding to the innate and acquired immune response - stronger immune response 


## Visualization | Age/sex vs. number of symptoms

```{r nsymptoms_age_sex, echo = FALSE, out.width = "800px", out.height= "350px", fig.align = "center"}
include_graphics("../results/nsymptoms_age_sex.png")
```


## Visualization | Vaccine manufacturer vs. number of symptoms

```{r nsymptoms_v_manu, echo = FALSE, out.width = "650px", out.height= "400px", fig.align = "center"}
include_graphics("../results/nsymptoms_v_manu.png")
```


## Visualization | Age vs. types of symptoms

```{r symptom_types_v_age, echo = FALSE, out.width = "550px", out.height= "450px", fig.align = "center"}
include_graphics("../results/symptom_types_v_age.png")
```


## Visualization | Sex vs. types of symptoms

```{r symptom_types_v_sex, echo = FALSE, out.width = "750px", out.height= "400px", fig.align = "center"}
include_graphics("../results/symptom_types_v_sex.png")
```


## Visualization | Vaccine manufacturer vs. types of symptoms

```{r symptom_types_v_manu, echo = FALSE, out.width = "875px", out.height= "455px", fig.align = "center"}
include_graphics("../results/symptom_types_v_manu.png")
```

# Exploratory Data Analysis | Principal Component Analysis

## PCA | Important tools used
Important verbs and tools used:

- prcomp()
- augment ()

## PCA | PCA plot and rotation matrix 

```{r, fig.show="hold", out.width="50%", out.height= "400px"}
include_graphics("../results/pca_plot.png")
include_graphics("../results/rotation_matrix.png")
```

## PCA | Scree plot 

```{r scree_plot, echo = FALSE, out.width = "750px", out.height= "400px", fig.align = "center"}
include_graphics("../results/scree_plot.png")
```


# Modelling | Logistic Regressions 


## Logistic Regression | Death ~ Patient Profile

Is the patient's profile (sex, age, allergic/not, ill/not, has/had covid/not) correlated with death?

```{r, eval = FALSE}
merged_data_wide %>%
  glm(formula = DIED ~ SEX + AGE_YRS + HAS_ALLERGIES + HAS_ILLNESS + HAS_COVID + HAD_COVID, 
      family = binomial) %>%
  tidy() %>%
  mutate(odds_ratio = exp(estimate))
```


```{r death_v_profile_model, eval=TRUE, echo=FALSE, error=FALSE, message=FALSE, warning=FALSE, tidy = TRUE}
model <- read_csv("../results/death_v_profile_model.csv")
model
```

## Logistic Regression | Death ~ Patient Profile

Is the patient's profile (sex, age, allergic/not, ill/not, has/had covid/not) correlated with death?

```{r death_v_profile_pval, echo = FALSE, out.width="50%", fig.show='hold'}
include_graphics(c("../results/death_v_profile_model_fig_pval.png", "../results/death_v_profile_model_fig_odds.png"))
```


## Logistic Regression | Death ~ Symptoms

Are some symptoms correlated with death?

```{r, eval = FALSE}
merged_data_wide %>%
  glm(formula = str_c("DEATH ~ ", str_c(symptoms, collapse = "+")), 
      family = binomial) %>%
  tidy() %>%
  mutate(odds_ratio = exp(estimate))
```


```{r death_v_symptoms_model, eval=TRUE, echo=FALSE, error=FALSE, message=FALSE, warning=FALSE, tidy = TRUE}
model <- read_csv("../results/death_v_symptoms_model.csv")
model %>%
  print(n = 8)
```


## Logistic Regression | Death ~ Symptoms

Are some symptoms correlated with death?

```{r, echo = FALSE, out.width="50%", fig.show='hold'}
include_graphics(c("../results/death_v_symptoms_model_fig_pval.png", "../results/death_v_symptoms_model_fig_odds.png"))
```



## Many Logistic Regressions | Each Symptom ~ Takes Anti-Inflamatory

Does taking anti-inflamatories modify the chance of having symptoms?

```{r, eval = FALSE}
merged_data_long %>%
  select(TAKES_ANTIINFLAMATORY, SYMPTOM, SYMPTOM_VALUE) %>%
  group_by(SYMPTOM) %>%
  nest %>% 
  ungroup %>%
  mutate(mdl = map(data, ~glm(TAKES_ANTIINFLAMATORY ~ SYMPTOM_VALUE,
                              family = binomial))) %>%
  mutate(mdl_tidy = map(mdl, ~tidy(.x, conf.int = TRUE)))
```


```{r symptoms_v_antiinfl_model, eval=TRUE, echo=FALSE, error=FALSE, message=FALSE, warning=FALSE}
model <- read_csv("../results/symptoms_v_antiinflamatory_model.csv")
model %>%
  select(-c(term, symptom_label, neg_log10_p)) %>%
  print(n = 5)
```



## Many Logistic Regressions | Each Symptom ~ Takes Anti-Inflamatory

```{r symptoms_v_antiinfl_manhattan, echo = FALSE, out.width="50%", fig.show='hold'}
include_graphics(c("../results/symptoms_v_antiinflamatory_model_fig_manhattan.png", "../results/symptoms_v_antiinflamatory_model_fig_odds.png"))
```




# Modelling | Chi-squared Contingency Table Tests

```{r echo = FALSE, include=FALSE}
contingency_table1 <- read_csv("/cloud/project/results/contingency_table1.csv")

contingency_table2 <- read_csv("/cloud/project/results/contingency_table2.csv")
```


## Chi-squared Contingency Table Tests | Vaccine Manufacturer and Death

Null hypothesis: the proportion of patients that died after getting one vaccine = the proportion of patients that died after getting another vaccine

```{r echo=FALSE, fig.show='hold', out.width="45%", fig.show='hold', out.extra='style = "float:right;padding:10px"'}
include_graphics("/cloud/project/results/manu_v_death.png")
```

```{r echo=FALSE}
contingency_table1
```


## Chi-squared Contingency Table Tests | Vaccine Manufacturer and Sex

Null hypothesis: the proportion of males that died after vaccination = the proportion of females that died after vaccination

```{r echo=FALSE, fig.show='hold', out.width="45%", fig.show='hold', out.extra='style = "float:right;padding:10px"'}
include_graphics("/cloud/project/results/manu_v_death.png")
```

```{r echo=FALSE}
contingency_table2
```


## Conclusion and discussion



## References

Dataset: https://www.kaggle.com/ayushggarg/covid19-vaccine-adverse-reactions?select=2021VAERSSYMPTOMS.csv

Dataset user guide: https://vaers.hhs.gov/docs/VAERSDataUseGuide_November2020.pdf





